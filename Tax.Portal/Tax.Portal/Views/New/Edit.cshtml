@model Tax.Portal.Models.NewViewModel
@using Tax.Portal.Models;

<div class="modal fade bs-modal-sm" id="deletepict" tabindex="-1" role="dialog" aria-labelledby="" aria-hidden="true">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title">Valóban törölni szeretné a fényképet?</h4>
            </div>
            <div class="modal-body">
                <p></p>
            </div>
            <div class="modal-footer">
                <div class="text-center">
                    <input id="btnPictDelete" type="button" class="btn btn-warning" data-dismiss="modal" value=" TÖRLÉS " />
                </div>
            </div>
        </div><!-- /.modal-content -->
    </div>
</div>

<div class="modal fade bs-modal-sm" id="morethanonepict" tabindex="-1" role="dialog" aria-labelledby="" aria-hidden="true">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title">Sajnos csak egyetlen fényképet fogadunk!</h4>
            </div>
            <div class="modal-body">
                <p></p>
            </div>
            <div class="modal-footer">
                <div class="text-center">
                    <input type="button" class="btn btn-warning" data-dismiss="modal" value=" OK " />
                </div>
            </div>
        </div><!-- /.modal-content -->
    </div>
</div>

@Html.ValidationSummary()
<div class="row" id="dz_section">
    <div class="col-sm-3 col-xs-12 pull-right" id="form_width">
        <form action="@Url.Action("Upload")" class="dropzone square" id="my-dropzone" style="background-color: cornsilk; ">
        </form>
    </div>
</div>

@using (Html.BeginForm(MVC.New.Edit(), FormMethod.Post, new { @id = "main", @class = "form-horizontal", @role = "form", @style = "padding-top:35px" }))
{
    @Html.HiddenFor(m => m.Id)
    @Html.HiddenFor(m => m.NewsStatusName)
    @Html.HiddenFor(m => m.Headline_pictureId)
    @Html.HiddenFor(m => m.ThumbnailId)
        
    <div id="filestoupload" class="filestoupload"></div>
    <div class="row">
        <div class="col-sm-4 col-xs-12">
            <div class="form-group">
                <div class="col-sm-12 col-xs-12">
                    @Html.LabelFor(m => m.Title1, new { @class = "control-label" })
                    <div class="input-group col-sm-12 col-xs-12">
                        @Html.TextBoxFor(m => m.Title1, new { @class = "form-control", placeholder = "Type here title1" })
                    </div>
                </div>
                <div class="col-sm-12 col-xs-12">
                    @Html.LabelFor(m => m.Title2, new { @class = "control-label" })
                    <div class="input-group col-sm-12 col-xs-12">
                        @Html.TextBoxFor(m => m.Title2, new { @class = "form-control", placeholder = "Type here title2" })
                    </div>
                </div>
                <div class="col-sm-12 col-xs-12">
                    @Html.LabelFor(m => m.Subtitle, new { @class = "control-label" })
                    <div class="input-group col-sm-12 col-xs-12">
                        @Html.TextBoxFor(m => m.Subtitle, new { @class = "form-control", placeholder = "Type here subtitle" })
                    </div>
                </div>
                <div class="col-sm-12 col-xs-12">
                    @Html.LabelFor(m => m.TagsIn, new { @class = "control-label" })
                    <div class="input-group col-sm-12 col-xs-12">
                        <div class="col-sm-10 col-xs-12" style="padding:0px">
                            @Html.DropDownListFor(m => m.TagsOut, new SelectList(Model.TagFromList, "Value", "Text"), new { @class = "form-control" })
                        </div>
                        <a id="add" class="btn btn-default col-sm-2 col-xs-12"><i class="fa fa-plus fa-fw"></i></a>                        
                    </div>
                    <div class="input-group col-sm-12 col-xs-12">
                        <div class="col-sm-10 col-xs-12" style="padding:0px">
                            @Html.ListBoxFor(m => m.TagsIn, new SelectList(Model.TagToList, "Value", "Text"), new { @class = "form-control" })
                        </div>
                        <a id="remove" class="btn btn-default col-sm-2 col-xs-12"><i class="fa fa-minus fa-fw"></i></a>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-sm-8 col-xs-12">
            <div class="form-group">
                @Html.LabelFor(m => m.Body_text, new { @class = "control-label" })
                <div class="input-group col-sm-12 col-xs-12">
                    @Html.TextAreaFor(m => m.Body_text, new { @class = "control-label" })
                </div>
            </div>        
        </div>
    </div>
}

@section Scripts {
    @Scripts.Render("~/Scripts/jqgrid")

    <link href="~/Scripts/ckeditor/contents.css" rel="stylesheet" />
    <script src="~/Scripts/ckeditor/ckeditor.js"></script>

    <script type="text/javascript">
        //repül a ckeditor
        CKEDITOR.replace('Body_text', {
            //height: 200,
            language: 'en'
        });

        //gombok a headerben
        $("#Publish").hide().css({ visibility: "hidden" });
        $("#CallBack").hide().css({ visibility: "hidden" });
        $("#Back").show().css({ visibility: "visible" });
        $("#Save").show().css({ visibility: "visible" });

        //kapcsoló lista kezelése
        $("#add").click(function () {
            if ($('#TagsOut').prop('selectedIndex') != 0) {
                $("#TagsOut > option:selected").each(function () {
                    $(this).remove().appendTo("#TagsIn");
                });
            }
        });
        $("#remove").click(function () {
            $("#TagsIn > option:selected").each(function () {
                $(this).remove().appendTo("#TagsOut");
            });
        });
        $("#TagsIn > option").each(function () {
            $(this).removeAttr('selected');            
        });
        $("#main").submit(function () {//csak selecttel tudom frissíteni a modellt
            $("#TagsIn > option").each(function () {
                $(this).attr('selected', 'selected');
            });
        });
    </script>

    <link rel="stylesheet" href="~/Scripts/dropzone/css/basic.css">
    <script src="~/Scripts/dropzone/dropzone.js"></script>
    <style type="text/css">
        .filestoupload {
            height: 0px;
        }

        .dz-max-files-reached {
            background-color: red;
        }

        .dropzone {
            margin: 0px 0px 10px 0px;
        }
    </style>

    <script>

        //nem törlök a dropzone-ból
        //function b(a) { return a ? (a ^ Math.random() * 16 >> a / 4).toString(16) : ([1e7] + -1e3 + -4e3 + -8e3 + -1e11).replace(/[018]/g, b) };
        //var afiles = []; //itt gyűjtjük a felküldött file-okat
        //var aids = [];

        Dropzone.options.myDropzone = {
            paramName: "file",
            addRemoveLinks: true,
            maxFiles: 1,
            accept: function (file, done) {
                console.log("uploaded");
                done();
            },
            init: function () {
                //this.on("error", function (file, message) { alert(message); });
                this.on("maxfilesexceeded", function (file) {
                    $('#morethanonepict').modal({
                        show: true
                    });
                });

                //nem törlök a dropzone-ból
                @*this.on("removedfile", function (file) {
                var position = $.inArray(file.name, afiles);
                if (~position) {
                    var id = aids[position];
                    afiles.splice(position, 1);
                    aids.splice(position, 1);
                    $("#storedfileid" + id).remove();
                    $.ajax({
                        url: '@Url.Action("DeleteAttachement", "Sinosz")',
                        type: 'POST',
                        data: {id: id}//,
                    });
                }
                });*@
                this.on("sending", function (file, xhr, formData) {
                    //nem törlök a dropzone-ból
                    //var id = b(0);
                    //afiles.push(file.name);
                    //aids.push(id)
                    //formData.append("id", id); // Will send the id along with the file as POST data.
                    formData.append("suserId", $("#userId").val());
                    if ($("#filetypeId").css("visibility") == "visible") {
                        formData.append("filetypeId", $("#filetypeId").val());
                    }
                    //nem törlök a dropzone-ból
                    //$("#filestoupload").append($("<input name=\"StoredFileIds\" type=\"hidden\" value=\"" + id + "\" id=\"storedfileid" + id + "\"/>"));
                    $("#filestoupload").append($("<input name=\"StoredNames\" type=\"hidden\" value=\"" + file.name + "\"/>")); //ez mindenképpen kell, mert küklönben nem megy fel a formdata
                });
                this.on("error", function (file, message) {
                    $('.dz-error-message').val(message);
                });
                var _this = this;
                this.on("success", function (file, responseText) {
                    //a feltöltött, kisöpröm
                    _this.removeAllFiles();
                    if ($("#filetypeId").css("visibility") == "visible") {
                        $("#files").trigger("reloadGrid", [{ current: true }]);
                    }
                    else {
                        $.ajax({//meg kell szerezni a kép azonosítóját
                            url: '@Url.Action("GetUserPictId", "Sinosz")?suserId=' + $("#userId").val(),
                            complete: function (request, textStatus) { //for additional info
                                $('#imageFile').attr('src', '@Url.Action("DownloadFirst", "Sinosz")?fileId=' + request.responseJSON);
                                $("#fileId").val(request.responseJSON);
                            },
                            loadError: function (xhr, status, error) { alert(status + " " + error); }
                        });
                        $("#deleteFile").show().css({ visibility: "visible" });
                        $("#imageFile").show().css({ visibility: "visible" });
                        $("#filetypeId").hide().css({ visibility: "hidden" });
                        $("#dz_section").hide().css({ visibility: "hidden" });
                    }
                    file.previewTemplate.appendChild(document.createTextNode(responseText));
                });

                @*a képvisszatöltés nem megy, és a form miatt nem is tudom használni
            var mockFile = {};
            var myDropzone = this;
            myDropzone.options.addedfile.call(myDropzone, mockFile);
            myDropzone.options.thumbnail.call(myDropzone, mockFile, '@Url.Action("DownloadFirst", "Sinosz")?suserId=' + $("#userId").val());*@
            }
        };

    </script>
}
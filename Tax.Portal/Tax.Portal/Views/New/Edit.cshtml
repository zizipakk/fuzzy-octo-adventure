@model Tax.Portal.Models.NewViewModel
@using Tax.Portal.Models;

<style type="text/css">
    .modal-dialog {
        width: 400px; /* your width */
        height: auto;
    }
</style>

<div class="modal fade bs-modal-sm" id="warningmodal" tabindex="-1" role="dialog" aria-labelledby="" aria-hidden="true">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header" style="color:orange">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title">WARNING</h4>
            </div>
            <div class="modal-body" style="color:orange">
                <p id="warningtext" style="text-align:center"></p>
            </div>
            <div class="modal-footer">
                <div class="text-center text-center">
                    <input type="button" class="btn btn-warning" data-dismiss="modal" value=" OK " />
                </div>
            </div>
        </div><!-- /.modal-content -->
    </div>
</div>

<div class="modal fade bs-modal-sm" id="errormodal" tabindex="-1" role="dialog" aria-labelledby="" aria-hidden="true">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header" style="color:red">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title">ERROR</h4>
            </div>
            <div class="modal-body" style="color:red">
                <p id="errortext" style="text-align:center"></p>
            </div>
            <div class="modal-footer">
                <div class="text-center text-center">
                    <input type="button" class="btn btn-danger" data-dismiss="modal" value=" OK " />
                </div>
            </div>
        </div><!-- /.modal-content -->
    </div>
</div>

<div class="row" style="padding-top:35px; margin-top: 0px;">
    @Html.ValidationSummary()
    <div class="col-sm-4 col-xs-12">
        @using (Html.BeginForm(MVC.New.Edit(), FormMethod.Post, new { @id = "main", @class = "form-horizontal", @role = "form", @style = "padding-top:0px; margin-top: 0px;" }))
        {
            @Html.HiddenFor(m => m.Id)
            @Html.HiddenFor(m => m.Mode)
            @Html.HiddenFor(m => m.NewsStatusName)         
            @Html.HiddenFor(m => m.Headline_pictureId)
            @Html.HiddenFor(m => m.ThumbnailId)
            @Html.HiddenFor(m => m.Body_text)

            <div class="form-group">
                <div class="col-sm-12 col-xs-12">
                    @Html.LabelFor(m => m.Title1, new { @class = "control-label" })<span style="font-size:15px; font-weight:bold; color:red"> *</span>
                    <div class="input-group col-sm-12 col-xs-12">
                        @Html.TextBoxFor(m => m.Title1, new { @class = "form-control", placeholder = "Type here title1" })
                    </div>
                </div>
                <div class="col-sm-12 col-xs-12">
                    @Html.LabelFor(m => m.Title2, new { @class = "control-label" })
                    <div class="input-group col-sm-12 col-xs-12">
                        @Html.TextBoxFor(m => m.Title2, new { @class = "form-control", placeholder = "Type here title2" })
                    </div>
                </div>
                <div class="col-sm-12 col-xs-12">
                    @Html.LabelFor(m => m.Subtitle, new { @class = "control-label" })
                    <div class="input-group col-sm-12 col-xs-12">
                        @Html.TextBoxFor(m => m.Subtitle, new { @class = "form-control", placeholder = "Type here subtitle" })
                    </div>
                </div>
                <div class="col-sm-12 col-xs-12">
                    @Html.LabelFor(m => m.TagsIn, new { @class = "control-label" })<span style="font-size:15px; font-weight:bold; color:red"> *</span>
                    <div class="input-group col-sm-12 col-xs-12">
                        <div class="col-sm-10 col-xs-12" style="padding:0px">
                            @Html.DropDownListFor(m => m.TagsOut, new SelectList(Model.TagFromList, "Value", "Text"), new { @class = "form-control" })
                        </div>
                        <a id="add" class="btn btn-default col-sm-2 col-xs-12"><i class="fa fa-plus fa-fw"></i></a>
                    </div>
                    <div class="input-group col-sm-12 col-xs-12">
                        <div class="col-sm-10 col-xs-12" style="padding:0px">
                            @Html.ListBoxFor(m => m.TagsIn, new SelectList(Model.TagToList, "Value", "Text"), new { @class = "form-control", @style="height:200px" })
                        </div>
                        <a id="remove" class="btn btn-default col-sm-2 col-xs-12"><i class="fa fa-minus fa-fw"></i></a>
                    </div>
                </div>
                <div class="col-sm-12 col-xs-12" style="padding-top:30px">
                    <span><b style="font-size:15px; color:red"> * required field</b></span>
                </div>
            </div>
        }
    </div>
    <div class="col-sm-8 col-xs-12" style="padding-left:0px;padding-right:0px">
        <div id="headline-upload" class="filestoupload" style="height: 0px"></div>
        <div id="thumbnail-upload" class="filestoupload" style="height: 0px"></div>
        <div class="form-group">
            <div class="col-sm-6 col-xs-12">
                @Html.LabelFor(m => m.Headline_pictureId, new { @style = "padding-top:7px; margin-bottom:0px" })<span style="font-size:15px; font-weight:bold; color:red"> *</span>
                <div class="input-group col-sm-12 col-xs-12">
                    <form action="@Url.Action("Upload", "New")" class="dropzone square" id="headline-dropzone" 
                          style="min-height:155px; padding: 0px 0px 0px 0px; background-color: white"></form>
                </div>
            </div>
            <div class="col-sm-3 col-xs-12">
                @Html.LabelFor(m => m.ThumbnailId, new { @style = "padding-top:7px; margin-bottom:0px" })<span style="font-size:15px; font-weight:bold; color:red"> *</span>
                <div class="input-group col-sm-12 col-xs-12">
                    <form action="@Url.Action("Upload", "New")" class="dropzone square" id="thumbnail-dropzone"
                          style="min-height:155px; padding: 0px 0px 0px 0px; background-color: white"></form>
                </div>
            </div>
            <div class="col-sm-12 col-xs-12">
                @Html.LabelFor(m => m.Body_text, new { @style = "padding-top:7px; margin-bottom:0px" })<span style="font-size:15px; font-weight:bold; color:red"> *</span>
                <div class="input-group col-sm-12 col-xs-12">
                    <form id="ckeditor_form">
                        @Html.TextArea("ckeditor_text", new { @style = "visibility:hidden" })
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @Scripts.Render("~/Scripts/jquery")
    @Scripts.Render("~/Scripts/bootstrap")
    @*<link href="~/Scripts/ckeditor/contents.css" rel="stylesheet" />*@
    <script src="~/Scripts/ckeditor/ckeditor.js"></script>

    <script type="text/javascript">
        //közös a view, ezért magic
        if ($('#Mode').val() == "create")
        {
            $('#main').attr('action', $('#actUrl').val());
        }
        //visszalépési irány
        $('#Back').attr('onclick', 'document.location.href = "@Url.Action(MVC.New.Index())"');


        //kitöltöm a fake taxtarea-t betöltésnél
        $('#ckeditor_text').val($('#Body_text').val());

        //repül a ckeditor
        CKEDITOR.replace('ckeditor_text', {
            height: 400,
            language: 'en',
            toolbar: [
                { name: 'document', groups: ['mode', 'document', 'doctools'], items: ['Source', '-', 'Templates'] },
                { name: 'basicstyles', groups: ['basicstyles'], items: ['Bold', 'Italic', 'Underline'] },
                { name: 'paragraph', groups: ['list', 'align'], items: ['NumberedList', 'BulletedList', '-', 'JustifyLeft', 'JustifyCenter', 'JustifyRight', 'JustifyBlock'] },
                { name: 'links', items: ['Link', 'Unlink'] },
                { name: 'insert', items: ['Image', 'Table'] },
                //{ name: 'styles', items: ['Styles', 'Format'] }
                { name: 'styles', items: ['Format'] }
            ]
        });
        CKEDITOR.config.format_tags = 'p;h1;h2';
        //nem megy
        //CKEDITOR.dataProcessor.htmlFilter.addRules({
        //    elements: {
        //        p: function (e) { e.attributes.style = 'font-size: 14px; font-family:"~/fonts/FrutigerNextPro-Light.otf";'; }
        //    }
        //});

        //gombok a headerben
        $("#CallBack").hide().css({ visibility: "hidden" });
        $("#Publish").hide().css({ visibility: "hidden" });
        $("#Back").show().css({ visibility: "visible" });
        $("#Save").show().css({ visibility: "visible" });

        //kapcsoló lista kezelése
        $("#add").click(function () {
            if ($('#TagsOut').prop('selectedIndex') != 0) {
                $("#TagsOut > option:selected").each(function () {
                    $(this).remove().appendTo("#TagsIn");
                });
            }
        });
        $("#remove").click(function () {
            $("#TagsIn > option:selected").each(function () {
                $(this).remove().appendTo("#TagsOut");
            });
        });
        $("#TagsIn > option").each(function () {
            $(this).removeAttr('selected');
        });
        $("#main").submit(function () {
            //visszatöltök az editorból
            $("#ckeditor_form").submit();
            //visszapakolok az igazi formra
            $("#Body_text").val($("#ckeditor_text").val());
            //csak selecttel tudom frissíteni a modellt
            $("#TagsIn > option").each(function () {
                $(this).attr('selected', 'selected');
            });
        });
    </script>

    <link rel="stylesheet" href="~/Scripts/dropzone/css/basic.css">
    <script src="~/Scripts/dropzone/dropzone.js"></script>
    <style type="text/css">
        .dz-message {
            text-align: center;
            padding-top: 35px;
        }
        .dz-max-files-reached {
            background-color: red;
        }
        /*.dropzone .dz-preview, .dropzone-previews .dz-preview {
            width: 320px;
            min-height: 125px;
        }
        .dropzone .dz-preview .dz-details, .dropzone-previews .dz-preview .dz-details {
            width: inherit;
            height: inherit;
        }
        .dropzone .dz-preview .dz-details img, .dropzone-previews .dz-preview .dz-details img {
            width: inherit;
            height: 130px;
        }*/
    </style>

    <script>
        function b(a) { return a ? (a ^ Math.random() * 16 >> a / 4).toString(16) : ([1e7] + -1e3 + -4e3 + -8e3 + -1e11).replace(/[018]/g, b) };
        //most csak egyet kezelőnk
        //var afiles = [];
        //var aids = [];

        Dropzone.options.headlineDropzone = {
            paramName: "file",
            addRemoveLinks: true,
            maxFiles: 1,
            accept: function (file, done) {
                console.log("uploaded");
                done();
            },
            init: function () {
                var id = null;
                //töltöm, ha van mi                
                if ($('#Headline_pictureId').val() != "")//már képem
                {
                    var mockFile = {};
                    this.options.addedfile.call(this, mockFile);
                    this.options.thumbnail.call(this, mockFile, '@Url.Action("DownloadImage", "New")?id=' + $("#Headline_pictureId").val());
                    this.options.maxFiles = 0;
                    $('.dz-filename').hide().css({ visibility: "hidden" });
                    $('.dz-size').hide().css({ visibility: "hidden" });
                }
                this.on("removedfile", function (file) {
                    //var position = $.inArray(file.name, afiles);
                    //if (~position) {
                    //    var id = aids[position];
                    //    afiles.splice(position, 1);
                    //    aids.splice(position, 1);
                    //    $("#storedfileid" + id).remove();
                    //    $.ajax({
                    //        url: '@Url.Action("DeleteImage", "New")',
                    //        type: 'POST',
                    //        data: { id: id }
                    //    });
                    //}
                    if (
                        $('#Headline_pictureId').val() != ""
                        && (new String(file.name) == "undefined"//régi kép
                            || id != null) //vagy most töltöttem fel hiab nélkül
                        )
                    {
                        $('#Headline_pictureId').val("");
                        this.options.maxFiles = 1;
                    }
                    if (id != null)//felküldtem, de meggondoltam magam
                    {
                        $("#headlinepictureid" + id).remove();
                        $.ajax({
                            url: '@Url.Action("DeleteImage", "New")',
                            type: 'POST',
                            data: { id: id }
                        });
                    }
                });
                this.on("sending", function (file, xhr, formData) {
                    id = b(0);
                    //afiles.push(file.name);
                    //aids.push(id)
                    formData.append("id", id); // Will send the id along with the file as POST data.
                    formData.append("picttype", "headline"); // Will send the id along with the file as POST data.
                    $("#headlineupload").append($("<input name=\"headlinepictureid\" type=\"hidden\" value=\"" + id + "\"/>"));
                });
                this.on("error", function (file, message) {
                    //$('.dz-error-message').val(message);
                    $("#headlinepictureid" + id).remove();
                    id = null;
                    $('#errortext').text(message);
                    $('#errormodal').modal({ show: true });
                });              
                this.on("success", function (file, responseText) {
                    $('#Headline_pictureId').val(id);
                    file.name = "undefined";
                    file.previewTemplate.appendChild(document.createTextNode(responseText));
                });
            }
        };

        Dropzone.options.thumbnailDropzone = {
            paramName: "file",
            addRemoveLinks: true,
            maxFiles: 1,
            accept: function (file, done) {
                console.log("uploaded");
                done();
            },
            init: function () {
                var id = null;
                //töltöm, ha van mi 
                if ($('#ThumbnailId').val() != "")//már képem
                {
                    var mockFile = {};
                    this.options.addedfile.call(this, mockFile);
                    this.options.thumbnail.call(this, mockFile, '@Url.Action("DownloadImage", "New")?id=' + $("#ThumbnailId").val());
                    this.options.maxFiles = 0;
                    $('.dz-filename').hide().css({ visibility: "hidden" });
                    $('.dz-size').hide().css({ visibility: "hidden" });
                }
                this.on("removedfile", function (file) {
                    //var position = $.inArray(file.name, afiles);
                    //if (~position) {
                    //    var id = aids[position];
                    //    afiles.splice(position, 1);
                    //    aids.splice(position, 1);
                    //    $("#storedfileid" + id).remove();
                    //    $.ajax({
                    //        url: '@Url.Action("DeleteImage", "New")',
                    //        type: 'POST',
                    //        data: { id: id }
                    //    });
                    //}
                    if (
                        $('#ThumbnailId').val() != ""
                        && (new String(file.name) == "undefined"//régi kép
                        || id != null) //vagy most töltöttem fel hiab nélkül
                    )
                    {
                        $('#ThumbnailId').val("");
                        this.options.maxFiles = 1;
                    }
                    if (id != null)//felküldtem, de meggondoltam magam
                    {
                        $("#thumbnailpictureid" + id).remove();
                        $.ajax({
                            url: '@Url.Action("DeleteImage", "New")',
                            type: 'POST',
                            data: { id: id }
                        });
                    }
                });
                this.on("sending", function (file, xhr, formData) {
                    id = b(0);
                    //afiles.push(file.name);
                    //aids.push(id)
                    formData.append("id", id); // Will send the id along with the file as POST data.
                    formData.append("picttype", "thumbnail"); // Will send the id along with the file as POST data.
                    $("#thumbnailupload").append($("<input name=\"thumbnailpictureid\" type=\"hidden\" value=\"" + id + "\"/>"));
                });
                this.on("error", function (file, message) {
                    //$('.dz-error-message').val(message);
                    $("#thumbnailpictureid" + id).remove();
                    id = null;
                    $('#errortext').text(message);
                    $('#errormodal').modal({ show: true });
                });
                this.on("success", function (file, responseText) {
                    $('#ThumbnailId').val(id);
                    file.previewTemplate.appendChild(document.createTextNode(responseText));
                });
            }
        };

    </script>
}
